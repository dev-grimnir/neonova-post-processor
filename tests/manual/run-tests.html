<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neonova Post-Processor - Manual Tests</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 1rem;
      line-height: 1.6;
      background: #f9f9f9;
    }
    h1 { text-align: center; color: #333; }
    #results { margin-top: 2rem; }
    .pass { color: #006400; font-weight: bold; }
    .fail  { color: #8B0000; font-weight: bold; }
    .summary { font-size: 1.4em; padding: 1rem; border-radius: 8px; }
    .success { background: #e8f5e9; color: #2e7d32; }
    .error   { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <h1>BaseNeonovaController Manual Tests</h1>
  <div id="results"></div>

  <!-- Load controller as classic script (no type=module → no strict MIME check) -->
  <script src="https://cdn.jsdelivr.net/gh/dev-grimnir/neonova-post-processor@dev/src/controllers/base-neonova-controller.js"></script>

  <script>
    // Wait briefly for the external script to load and define the class
    window.addEventListener('load', () => {
      setTimeout(() => {
        const results = document.getElementById('results');

        if (typeof BaseNeonovaController === 'undefined') {
          results.innerHTML = '<p class="fail">Error: BaseNeonovaController not loaded. Check console for issues.</p>';
          return;
        }

        let pass = 0;
        let total = 0;

        function assert(ok, msg) {
          total++;
          const p = document.createElement('p');
          p.textContent = (ok ? '✓ ' : '✗ ') + msg;
          p.className = ok ? 'pass' : 'fail';
          results.appendChild(p);
          if (ok) pass++;
        }

        const ctrl = new BaseNeonovaController();

        // Test 1
        const url = ctrl.getSearchUrl('testuser123');
        assert(url.includes('iuserid=testuser123'), 'URL contains the username');
        assert(url.includes('sday=01'), 'URL starts on day 01');
        assert(url.includes('smonth=') && url.includes('syear='), 'URL has month and year');

        // Test 2 - valid parsing
        const sampleHtml = `
<table cellspacing="2" cellpadding="2">
  <tr>
    <td>2025-07-10 14:30:00</td><td></td><td></td><td></td>
    <td>Stop</td><td></td><td>00:45:12</td>
  </tr>
  <tr>
    <td>2025-07-10 13:45:48</td><td></td><td></td><td></td>
    <td>Start</td><td></td><td></td>
  </tr>
</table>`;
        const doc = new DOMParser().parseFromString(sampleHtml, 'text/html');
        const entries = ctrl.parsePageRows(doc);

        assert(entries.length === 2, 'Parses exactly 2 entries');
        assert(entries[0].status === 'Stop', 'First entry is Stop');
        assert(entries[1].status === 'Start', 'Second entry is Start');
        assert(entries[0].dateObj instanceof Date && !isNaN(entries[0].dateObj), 'Stop has valid Date');

        // Test 3 - invalid skipped
        const badHtml = `<table><tr><td>invalid</td><td>x</td><td>x</td><td>x</td><td>Stop</td><td>x</td><td>00:00:00</td></tr></table>`;
        const badDoc = new DOMParser().parseFromString(badHtml, 'text/html');
        assert(ctrl.parsePageRows(badDoc).length === 0, 'Skips invalid date rows');

        // Summary
        const summary = document.createElement('div');
        summary.className = 'summary ' + (pass === total ? 'success' : 'error');
        summary.textContent = `${pass} / ${total} tests passed`;
        results.prepend(summary);
      }, 800);  // give time for script to execute
    });
  </script>
</body>
</html>
