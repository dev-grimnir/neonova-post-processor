<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neonova Post-Processor - Manual Tests</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; max-width: 800px; margin: auto; line-height: 1.6; }
    .pass { color: #2e7d32; font-weight: bold; }
    .fail { color: #d32f2f; font-weight: bold; }
    h1, h2 { text-align: center; color: #333; }
    #results { margin-top: 1.5rem; }
  </style>
</head>
<body>
  <h1>BaseNeonovaController Tests (Browser)</h1>
  <div id="results"></div>

  <script type="module">
    // Use jsDelivr to load the controller with correct MIME type
    import { BaseNeonovaController } from 'https://cdn.jsdelivr.net/gh/dev-grimnir/neonova-post-processor@dev/src/controllers/base-neonova-controller.js';

    const resultsDiv = document.getElementById('results');
    let passCount = 0;
    let total = 0;

    function assert(condition, message) {
      total++;
      const p = document.createElement('p');
      p.textContent = (condition ? '✓ ' : '✗ ') + message;
      p.className = condition ? 'pass' : 'fail';
      resultsDiv.appendChild(p);
      if (condition) passCount++;
    }

    const ctrl = new BaseNeonovaController();

    // Test 1: getSearchUrl
    const url = ctrl.getSearchUrl('testuser123');
    assert(url.includes('iuserid=testuser123'), 'includes username in query param');
    assert(url.includes('sday=01'), 'starts on day 01 of current month');
    assert(url.includes('smonth=') && url.includes('syear='), 'contains month and year params');

    // Test 2: parsePageRows - valid data
    const htmlValid = `
<table cellspacing="2" cellpadding="2">
  <tr><td>2025-07-15 09:45:00</td><td></td><td></td><td></td><td>Stop</td><td></td><td>01:23:45</td></tr>
  <tr><td>2025-07-15 08:20:15</td><td></td><td></td><td></td><td>Start</td><td></td><td></td></tr>
</table>`;
    const docValid = new DOMParser().parseFromString(htmlValid, 'text/html');
    const entries = ctrl.parsePageRows(docValid);
    assert(entries.length === 2, 'parses exactly 2 valid entries');
    assert(entries[0].status === 'Stop' && entries[1].status === 'Start', 'entries have correct status order');
    assert(entries[0].dateObj instanceof Date && !isNaN(entries[0].dateObj.getTime()), 'Stop entry has valid Date object');

    // Test 3: invalid date skipped
    const htmlInvalid = `<table><tr><td>not-a-date</td><td>x</td><td>x</td><td>x</td><td>Stop</td><td>x</td><td>00:00:00</td></tr></table>`;
    const docInvalid = new DOMParser().parseFromString(htmlInvalid, 'text/html');
    assert(ctrl.parsePageRows(docInvalid).length === 0, 'skips rows with invalid dates');

    // Summary
    const summary = document.createElement('h2');
    summary.textContent = `${passCount} / ${total} tests passed`;
    summary.style.color = passCount === total ? '#2e7d32' : '#d32f2f';
    resultsDiv.prepend(summary);
  </script>
</body>
</html>
